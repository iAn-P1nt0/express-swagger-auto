name: Performance Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      update_baseline:
        description: 'Update performance baseline'
        required: false
        default: 'false'

jobs:
  performance:
    runs-on: ubuntu-latest
    name: Performance Benchmarks
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Run Performance Tests
        run: pnpm test:performance
        continue-on-error: true
        id: perf_tests

      - name: Run Benchmarks
        run: pnpm benchmark
        continue-on-error: true
        id: benchmarks

      - name: Compare to Baseline
        if: steps.benchmarks.outcome == 'success'
        run: npx tsx benchmarks/compare.ts --tolerance 10
        continue-on-error: true
        id: comparison

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmarks/results/*.json
            benchmarks/results/*.md
          retention-days: 30

      - name: Update Baseline (Manual)
        if: github.event.inputs.update_baseline == 'true' && github.ref == 'refs/heads/main'
        run: npx tsx benchmarks/compare.ts --update-baseline

      - name: Comment on PR with Results
        if: github.event_name == 'pull_request' && steps.benchmarks.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find latest report
            const resultsDir = 'benchmarks/results';
            const files = fs.readdirSync(resultsDir)
              .filter(f => f.startsWith('report-') && f.endsWith('.md'))
              .sort()
              .reverse();
            
            if (files.length === 0) {
              console.log('No benchmark report found');
              return;
            }
            
            const reportPath = path.join(resultsDir, files[0]);
            let reportContent = fs.readFileSync(reportPath, 'utf-8');
            
            // Truncate if too long
            if (reportContent.length > 60000) {
              reportContent = reportContent.substring(0, 60000) + '\n\n... (truncated)';
            }
            
            const body = `## ðŸ“Š Performance Benchmark Results
            
            <details>
            <summary>Click to expand benchmark report</summary>
            
            ${reportContent}
            
            </details>
            
            ---
            *Generated by Performance Tests workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check for Regressions
        if: steps.comparison.outcome == 'failure'
        run: |
          echo "âš ï¸ Performance regressions detected!"
          echo "Please review the benchmark results and consider optimizations."
          exit 1

  trend-tracking:
    runs-on: ubuntu-latest
    needs: performance
    if: github.ref == 'refs/heads/main'
    name: Track Performance Trends
    
    steps:
      - uses: actions/checkout@v4

      - name: Download Benchmark Results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          path: benchmarks/results

      - name: Store Results for Trending
        uses: actions/cache@v4
        with:
          path: benchmarks/history
          key: perf-history-${{ github.run_number }}
          restore-keys: |
            perf-history-

      - name: Append to History
        run: |
          mkdir -p benchmarks/history
          LATEST=$(ls -t benchmarks/results/benchmark-*.json 2>/dev/null | head -1)
          if [ -n "$LATEST" ]; then
            cp "$LATEST" "benchmarks/history/$(date +%Y%m%d)-${{ github.run_number }}.json"
          fi

      - name: Generate Trend Report
        run: |
          echo "ðŸ“ˆ Performance History"
          ls -la benchmarks/history/*.json 2>/dev/null | tail -10 || echo "No history yet"
